name: Canary Drift Nightly

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch: {}

jobs:
  drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: sintari-relations
        run: |
          npm ci
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi

      - name: Normalise telemetry
        working-directory: sintari-relations
        run: |
          if [ -f reports/worldclass_live.jsonl ]; then
            node scripts/metrics/normalise_worldclass_live.mjs reports/worldclass_live.jsonl --out reports/worldclass_live.norm.jsonl --enforce-monotonic --dedupe-sec 900 --session-window-limit 50
          else
            echo "⚠️ reports/worldclass_live.jsonl not found"
            exit 0
          fi

      - name: Schema + gates
        working-directory: sintari-relations
        run: |
          npm run schema:validate -- reports/worldclass_live.norm.jsonl
          python scripts/metrics/enforce_style_gate.py reports/worldclass_live.norm.jsonl --parity-p95-like-gap 0.02 --strict-lang-match
          python scripts/metrics/enforce_parity_gate.py reports/worldclass_live.norm.jsonl
          python scripts/metrics/enforce_honesty_gate.py reports/worldclass_live.norm.jsonl --min-honesty-rate 0.10 --no-advice-when-honest 1 --min-repair-accept 0.50
          python scripts/metrics/enforce_red_snapshot.py reports/worldclass_live.norm.jsonl tests/golden/style/red_farewell_snap.json

      - name: Canary drift alarm
        working-directory: sintari-relations
        run: |
          python scripts/si/canary_drift_alarm.py --in reports/worldclass_live.norm.jsonl --window-min 15 --breach 3 --out reports/si/canary_drift_log.jsonl || echo "Drift alarm triggered"

      - name: Upload artefacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canary-drift-log
          path: |
            sintari-relations/reports/si/canary_drift_log.jsonl
            sintari-relations/reports/worldclass_live.norm.jsonl

